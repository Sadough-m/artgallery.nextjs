import React, { useEffect, useState } from "react";
import Link from "next/link";

// gm : material ui ↓
import {Button, Grid, Hidden, IconButton} from "@material-ui/core";
import HeaderLanding from "../../../../components/common/header";

// gm : styles ↓
import Style from "../../../../styles/Orders.module.css";

// gm : files ↓
import CloseSvg from "../../../../public/images/icons/Close dark.svg";
import ArrowLeft from "../../../../public/images/icons/Arrow left -.svg";

// gm : components ↓
import Summary from "../../../../components/Screens/Orders/Payment/Summary";
import PaymentTo from "../../../../components/Screens/Orders/Payment/PaymentTo";
import Artwork from "../../../../components/Screens/Orders/Payment/Artworks";
import PaymentMethod from "../../../../components/Screens/Orders/Payment/PaymentMethod";
import Note from "../../../../components/Screens/Orders/Main/Note";
import {useRouter} from "next/router";
import {GetAuthUrl, PostAuthUrl} from "../../../api/config";
import {Create_Payment_Data, Get_Payment_Data} from "../../../api";
import {toast} from "react-toastify";

import LoadingSpinerSvg from "../../../../public/loading.svg";

export default function _markAsPaid() {
    const router = useRouter();

<<<<<<< HEAD
    // gm : states ↓
    const [paymentData, setPaymentData] = useState({});
    const [selectedArtWork, setSelectedArtWork] = useState([]);
    const [orderId, setOrderId] = useState('');
    const [markAsPaid, setMarkAsPaid] = useState(false);
    const [artworkFreeze, setArtworkFreeze] = useState(false);
    const [paidOutSide, setPaidOutSide] = useState(false);
    const [selectedOutSidePaymentType, setSelectedOutSidePaymentType] = useState({});
    const [selectedPayMethodIdFreeze, setSelectedPayMethodIdFreeze] = useState(false)
    const [apiLoadCounter, setApiLoadCounter] = useState(0);
    ;
    const [freezeObj, setFreezeObj] = useState({
        artworkFreeze: false,
        paidOutSideFreeze: false,
        selectedPaidOutSideTypeFreeze: false,
        selectedPayMethodIdFreeze: false,
    });


    useEffect(() => {
        console.log('router', router)
        if (router.asPath !== router.route) {
            const {_orderId, _markAsPaid} = router.query;
            // setOrderData(setOrderData);
            console.log('orderId', _orderId, _markAsPaid)
            // getDraftData(orderID);
            setMarkAsPaid(_markAsPaid === 'true')
            setOrderId(_orderId)
            getPaymentData({_orderId: _orderId, _markAsPaid: _markAsPaid === 'true'});

        }
    }, [router]);

    // sa: get all  detail
    const getPaymentData = async ({
                                      _orderId = orderId,
                                      _markAsPaid = markAsPaid,
                                      _selectedArtWork = selectedArtWork,
                                      _paidOutSide = paidOutSide,
                                      _selectedPaidOutSideType = setSelectedOutSidePaymentType
                                  }) => {
        setApiLoadCounter(apiLoadCounter + 1)
        await PostAuthUrl(Get_Payment_Data(_markAsPaid), {
            "orderId": _orderId,
            "selectedItems": _selectedArtWork,
            "paidOutSide": _paidOutSide,
            "billingAddress": null,
            "selectedPaidOutSideType": _selectedPaidOutSideType?.id ? _selectedPaidOutSideType?.id : null,
            "selectedPayMethodId": null,
            "isFirstTimeLoadPage": apiLoadCounter == 0 ? true : false

        }).then((res, err) => {
            if (res && res.status === 200) {
                if (res?.data?.isSuccess) {
                    // res.data.data.payments=[
                    //   {
                    //     "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
                    //     "paidDateTime": "20022 - 06 - 01",
                    //     "type": "payment",
                    //     "totalPayment": "$10",
                    //     "paymentNumber": "##1"
                    //   }
                    // ]
                    // res.data.data.timelines=  [
                    //   {
                    //     "date": "20022 - 06 - 01",
                    //     "time": "20 : 30",
                    //     "title": "News",
                    //     "description": "Any time at your service .",
                    //     "relatedId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
                    //     "collectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
                    //   }
                    // ]
                    // res.data.data.tags=  [
                    //   'test'
                    // ]
                    setPaymentData(res.data.data);
                    let selected = res.data.data?.items?.filter(x => x.selected == true).map(x => x.id)
                    // console.log('selected',selected)
                    setSelectedArtWork(selected)
                    setPaidOutSide(res?.data?.data?.paidOutSide)
                    setSelectedOutSidePaymentType((res?.data?.data?.outSidePaymentTypes?.find(x => x.selected)))
                    // console.log('Get_Payment_Data',res.data.data)
                } else {
                    toast.error(res?.data?.message);
                }
            } else {
                toast.error("something went wrong !");
            }
        });
    };
    // sa: create payment  detail
    const createPaymentData = async () => {
        await PostAuthUrl(Get_Payment_Data(markAsPaid), {
            "orderId": orderId,
            "selectedItems": selectedArtWork,
            "paidOutSide": paidOutSide,
            "billingAddress": null,
            "selectedPaidOutSideType": selectedOutSidePaymentType?.id ? selectedOutSidePaymentType?.id : null,
            "selectedPayMethodId": null,
            "isFirstTimeLoadPage": false

        }).then((res, err) => {
            if (res && res.status === 200) {
                if (res?.data?.isSuccess) {
                    toast.success(res?.data?.message);
                    router.push(`/orders/orderPreview/${orderId}`)

                } else {
                    toast.error(res?.data?.message);
                }
            } else {
                toast.error("something went wrong !");
            }
        });
    };

    //sa : handle Selected Items Changed
    const handleChangeSelectedArtworks = async (artworks) => {
        let selected = artworks?.filter(x => x.selected == true).map(x => x.id)

        // console.log('selected',selected)
        setSelectedArtWork(selected)
        setFreezeObj({...freezeObj, artworkFreeze: true})
        await getPaymentData({_selectedArtWork: selected})
        setFreezeObj({...freezeObj, artworkFreeze: false})
=======
  // gm : states ↓
  const [paymentData, setPaymentData] = useState({});
  const [selectedArtWork, setSelectedArtWork] = useState([]);
  const [orderId, setOrderId] = useState('');
  const [markAsPaid, setMarkAsPaid] = useState(false);
  const [artworkFreeze, setArtworkFreeze] = useState(false);
  const [paidOutSide, setPaidOutSide] = useState(false);
  const [selectedOutSidePaymentType, setSelectedOutSidePaymentType] = useState({});
  const [selectedPayMethodIdFreeze, setSelectedPayMethodIdFreeze] = useState(false)
  const [apiLoadCounter, setApiLoadCounter] = useState(0);
  ;
  const [freezeObj, setFreezeObj] = useState({
    artworkFreeze: false,
    paidOutSideFreeze: false,
    selectedPaidOutSideTypeFreeze: false,
    selectedPayMethodIdFreeze: false,
  });


  useEffect(() => {
    console.log('router', router)
    if (router.asPath !== router.route) {
      const { _orderId, _markAsPaid } = router.query;
      // setOrderData(setOrderData);
      console.log('orderId', _orderId, _markAsPaid)
      // getDraftData(orderID);
      setMarkAsPaid(_markAsPaid === 'true')
      setOrderId(_orderId)
      getPaymentData({ _orderId: _orderId, _markAsPaid: _markAsPaid === 'true' });
>>>>>>> dc1540e54dac3be414bd139592f2d60a08d270cc

    }

<<<<<<< HEAD
    //sa :  handle ChangePaidOutSide Changed
    const handleChangePaidOutSide = async (status) => {
        setPaidOutSide(status)
        setFreezeObj({...freezeObj, paidOutSideFreeze: true})
        await getPaymentData({_paidOutSide: status})
        setFreezeObj({...freezeObj, paidOutSideFreeze: false})

    }

    //sa :  handle SelectedOutSidePaymentType Changed
    const handleSelectedOutSidePaymentType = async (obj) => {

        setSelectedOutSidePaymentType(obj)
        setFreezeObj({...freezeObj, selectedPaidOutSideTypeFreeze: true})
        await getPaymentData({_selectedPaidOutSideType: obj})
        setFreezeObj({...freezeObj, selectedPaidOutSideTypeFreeze: false})

    }

    // sa: loading component
    const loading = () => {
        return <Grid style={{display:'flex',alignItems:'center',justifyContent:'center'}}
        >
            <img style={{width: "60px"}} src={LoadingSpinerSvg.src}/>
=======
  // sa: get all  detail
  const getPaymentData = async ({
    _orderId = orderId,
    _markAsPaid = markAsPaid,
    _selectedArtWork = selectedArtWork,
    _paidOutSide = paidOutSide,
    _selectedPaidOutSideType = setSelectedOutSidePaymentType
  }) => {
    setApiLoadCounter(apiLoadCounter + 1)
    await PostAuthUrl(Get_Payment_Data(_markAsPaid), {
      "orderId": _orderId,
      "selectedItems": _selectedArtWork,
      "paidOutSide": _paidOutSide,
      "billingAddress": null,
      "selectedPaidOutSideType": _selectedPaidOutSideType?.id ? _selectedPaidOutSideType?.id : null,
      "selectedPayMethodId": null,
      "isFirstTimeLoadPage": apiLoadCounter == 0 ? true : false

    }).then((res, err) => {
      if (res && res.status === 200) {
        if (res?.data?.isSuccess) {
          // res.data.data.payments=[
          //   {
          //     "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
          //     "paidDateTime": "20022 - 06 - 01",
          //     "type": "payment",
          //     "totalPayment": "$10",
          //     "paymentNumber": "##1"
          //   }
          // ]
          // res.data.data.timelines=  [
          //   {
          //     "date": "20022 - 06 - 01",
          //     "time": "20 : 30",
          //     "title": "News",
          //     "description": "Any time at your service .",
          //     "relatedId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
          //     "collectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa6"
          //   }
          // ]
          // res.data.data.tags=  [
          //   'test'
          // ]
          setPaymentData(res.data.data);
          let selected = res.data.data?.items?.filter(x => x.selected == true).map(x => x.id)
          // console.log('selected',selected)
          setSelectedArtWork(selected)
          setPaidOutSide(res?.data?.data?.paidOutSide)
          setSelectedOutSidePaymentType((res?.data?.data?.outSidePaymentTypes?.find(x => x.selected)))
          // console.log('Get_Payment_Data',res.data.data)
        } else {
          toast.error(res?.data?.message);
        }
      } else {
        toast.error("something went wrong !");
      }
    });
  };
  // sa: create payment  detail
  const createPaymentData = async (NewAddress) => {
    await PostAuthUrl(Get_Payment_Data(markAsPaid), {
      "orderId": orderId,
      "selectedItems": selectedArtWork,
      "paidOutSide": paidOutSide,
      "billingAddress": NewAddress ? NewAddress : paymentData?.billingAddress,
      "selectedPaidOutSideType": selectedOutSidePaymentType?.id ? selectedOutSidePaymentType?.id : null,
      "selectedPayMethodId": null,
      "isFirstTimeLoadPage": false
    }).then((res, err) => {
      if (res && res.status === 200) {
        if (res?.data?.isSuccess) {
          toast.success(res?.data?.message);
          router.push(`/orders/orderPreview/${orderId}`)
        } else {
          toast.error(res?.data?.message);
        }
      } else {
        toast.error("something went wrong !");
      }
    });
  };

  //sa : handle Selected Items Changed
  const handleChangeSelectedArtworks = async (artworks) => {
    let selected = artworks?.filter(x => x.selected == true).map(x => x.id)
    console.log('selected', selected)
    // console.log('selected',selected)
    setSelectedArtWork(selected)
    setFreezeObj({ ...freezeObj, artworkFreeze: true })
    await getPaymentData({ _selectedArtWork: selected })
    setFreezeObj({ ...freezeObj, artworkFreeze: false })

  }

  //sa :  handle ChangePaidOutSide Changed
  const handleChangePaidOutSide = async (status) => {
    setPaidOutSide(status)
    setFreezeObj({ ...freezeObj, paidOutSideFreeze: true })
    await getPaymentData({ _paidOutSide: status })
    setFreezeObj({ ...freezeObj, paidOutSideFreeze: false })

  }

  //sa :  handle SelectedOutSidePaymentType Changed
  const handleSelectedOutSidePaymentType = async (obj) => {

    setSelectedOutSidePaymentType(obj)
    setFreezeObj({ ...freezeObj, selectedPaidOutSideTypeFreeze: true })
    await getPaymentData({ _selectedPaidOutSideType: obj })
    setFreezeObj({ ...freezeObj, selectedPaidOutSideTypeFreeze: false })

  }

  // sa: loading component
  const loading = () => {
    return <Grid
    >
      <img style={{ width: "60px" }} src={LoadingSpinerSvg.src} />
    </Grid>
  }
  return (
    <Grid item>
      <Grid container>
        {/* left side */}
        <Grid item className={Style.LeftSide__Payment}>
          <Grid item className={Style.TextCreatePay}>
            <Hidden mdUp>
              <IconButton>
                <img src={ArrowLeft.src} />
              </IconButton>
            </Hidden>
            Create payment
          </Grid>
>>>>>>> dc1540e54dac3be414bd139592f2d60a08d270cc
        </Grid>
    }
    return (
        <Grid item>
            <Grid container>
                {/* left side */}
                <Grid item className={Style.LeftSide__Payment}>
                    <Grid item className={Style.TextCreatePay}>
                        <Hidden mdUp>
                            <IconButton>
                                <img src={ArrowLeft.src}/>
                            </IconButton>
                        </Hidden>
                        Create payment
                    </Grid>
                </Grid>

<<<<<<< HEAD
                {/* Middle */}
                <Grid item className={Style.Middle_Payment}>
                    {/* Componensts */}
                    <Artwork
                        AllData={paymentData}
                        handleChangeSelectedArtworks={handleChangeSelectedArtworks}
                        handleChangePaidOutSide={handleChangePaidOutSide}
                        handleSelectedOutSidePaymentType={handleSelectedOutSidePaymentType}
                        loadingComp={loading}
                        freezeObj={freezeObj}
                    />
                    {/*<Note />*/}
                    {
                        !paidOutSide &&
                        <PaymentMethod AllData={paymentData}/>
                    }
=======
        {/* Middle */}
        <Grid item className={Style.Middle_Payment}>
          {/* Componensts */}
          <Artwork
            AllData={paymentData}
            handleChangeSelectedArtworks={handleChangeSelectedArtworks}
            handleChangePaidOutSide={handleChangePaidOutSide}
            handleSelectedOutSidePaymentType={handleSelectedOutSidePaymentType}
            loadingComp={loading}
            freezeObj={freezeObj}
            HiddenAllChecked={true}
          />
          {/*<Note />*/}
          {
            !paidOutSide &&
            <PaymentMethod AllData={paymentData} />
          }
>>>>>>> dc1540e54dac3be414bd139592f2d60a08d270cc

                    <br/>
                    <br/>
                </Grid>

                {/* Right Side */}
                <Grid item className={Style.RightSide_Payment}>
                    <Grid item className={Style.Wrapper_Right2}>
                        <Hidden smDown>
                            <Button
                                className={Style.DiscardButton}
                                startIcon={<img src={CloseSvg.src}/>}
                                onClick={() => router.push(`/orders/orderPreview/${orderId}`)}
                            >
                                Discard
                            </Button>
                        </Hidden>
                        {/* Componensts */}
                        <Hidden smDown>
                            <Summary
                                AllData={paymentData}
                                createPaymentData={createPaymentData}
                                type='payment'
                            />
                        </Hidden>
                        <PaymentTo/>
                    </Grid>
                </Grid>
            </Grid>
            {/* Componensts */}
<<<<<<< HEAD
            <Hidden mdUp>
                <Grid item style={{marginTop: -15}}>
                    <Summary
                        type='payment'
                        AllData={paymentData}
                        createPaymentData={createPaymentData}

                    />
                </Grid>
            </Hidden>
=======
            <Hidden smDown>
              <Summary
                AllData={paymentData}
                createPaymentData={createPaymentData}
                type='payment'
              />
            </Hidden>
            <PaymentTo
              AllData={paymentData}
              setAllData={setPaymentData}
              createPaymentData={createPaymentData}
            />
          </Grid>
        </Grid>
      </Grid>
      {/* Componensts */}
      <Hidden mdUp>
        <Grid item style={{ marginTop: -15 }}>
          <Summary
            type='payment'
            AllData={paymentData}
            createPaymentData={createPaymentData}
          />
>>>>>>> dc1540e54dac3be414bd139592f2d60a08d270cc
        </Grid>
    );
}
